---
layout: docs
language: ko
category: 운영체제
title: CPU
meta: CPU
order: 0x42
---
# CPU 진단
> https://docs.microsoft.com/en-us/windows-hardware/test/wpt/cpu-analysis#windows-adk-tools

평가 척도에 영향을 주는 CPU 관련 이슈 진단에 대한 자세한 기법들을 소개한다.

세 부분으로 나뉘어진다:

* 배경: 윈도우가 CPU 리소스를 어떻게 관리하는지 설명한다.

* [윈도우 ADK](https://docs.microsoft.com/en-us/windows-hardware/get-started/adk-install)(Assessment and Deployment Kit): 윈도우 ADK로부터 어떻게 CPU 정보를 읽고 해석하는 설명한다.

* 기법: CPU 성능과 관련된 흔히 발생할 수 있는 문제들을 진단 및 해결할 수 있는 여러 기법들을 다룬다.

# CPU 진단: 배경
CPU에 대한 간단한 설명. 더 자세한 내용은 Windows Internal, Fifth Edition 읽을 것을 권장.

현대 컴퓨터는 별개의 소켓에 여러 CPU 설치 가능. 각 CPU는 여러 물리적 프로세서 탑재하고, 각 프로세서는 하나 또는 두 개의 명령 흐름(문맥상 thread로 판단)을 동시 처리 가능. 윈도우 운영체제에서 명령 흐름을 처리하는 프로세서 = 논리 프로세서(logical processor)라고 칭함.

본 내용은 프로세서와 CPU를 논리 프로세서라고 언급한다: 즉, 운영체제에서 프로그램 명령을 실행하기 위해 사용할 수 있는 하드웨어 장치이다.

윈도우 10은 지속적으로 프로세서 하드웨어를 두 주요 방식으로 관리한다: (1) 전력 소모와 성능의 균형을 위한 전력 관리(power management) 그리고 (2) 프로그램과 드라이버의 프로세싱 요구사항의 균형을 위한 사용량(usage).

## 프로세서 전력 관리
프로세서는 항상 동작 중에 있지 않는다. 실행할 명령이 없으면 운영체제는 윈도우 전력 관리자로 결정되 바에 따라 프로세서를 target idle (혹은 C-상태)로 만든다. CPU 사용 패턴을 기반하여 프로세서의 target C-상태는 시간이 지남에 따라 조정된다.

idle 상태는 C0(active; idle하지 않음)으로부터 시작해 점차적으로 저전력 상태로 번호가 매겨진 상태이다: C1(멈췄지만 클락은 여전히 활성화), C2(멈췄으며 클락 비활성화), 그리고 쭉 이어진다. idle 상태에 대한 적용은 프로세서마다 다르다. 하지만 숫자가 높을수록 저전력 소모인 것은 동일하며, 다시 명령을 처리할 수 있도록 꺠어나는데 걸리는 시간이 길어진다. idle 상태로 얼마나 있었는지에 따라 에너지 사용량 및 배터리 수명에 상당한 영향을 준다.

일부 프로세서는 활발히 명령을 처리하고 있음에도 performance 상태(P-)와 throttle 상태(T-) 상태에 있을 수 있다. P-상태는 프로세서가 지원하는 클락 주파수와 전압 레벨을 정의한다. T-상태는 직접적으로 클락 주파수를 바꾸지 않지만, 명령 처리 과정에서 몇몇 클락 트리거 엣지 때 프로세싱 활동을 건너뛰어 실질적 클락 속도를 낮출 수 있다. 이렇게 현 P-상태와 T-상태가 함께 프로세서의 실질적 동작 주파수를 결정한다. 낮은 동작 주파수는 저성능 및 저전력소모에 대응한다.

윈도우 전력 관리자는 CPU 사용 패턴과 시스템 전력 정책을 기반으로 각 프로세서에 적합한 P- 및 T-상태를 결정한다. 고성능 상태 vs 저성는 상태에 있던 시간은 에너지 사용량과 배터리 수명에 상당한 영향을 준다.

## 프로세서 사용량 관리
윈도우는 다음 세 개의 추상으로부터 프로세서 사용량을 관리한다.

* 프로세스
* 스레드
* DPC(Deferred Procedure Call)와 ISR(Interrupt Service Routines)

### 프로세스 및 스레드
윈도우의 모든 사용자 모드 프로그램은 프로세스라는 문맥에서 실행된다. 프로세스는 다음으로 구성된다:

* 가상 주소 공간
* 우선권 클래스
* 실행 코드
* 환경 블록 및 설정
* 최소 스레드 한 개

프로세스는 실행 코드, 환경 블록, 문맥 등의 리소스를 갖고 있으나 프로세서로 스케줄링되어 처리되지 않는다. 실질적인 실행 문맥을 가지고 있는 스레드가 스케줄링되어 프로세서에서 실행된다. 스레드 활동이 근본적으로 시스템 성능과 측정에 영향을 준다.

시스템 내의 프로세서 개수는 제한적이므로 모든 스레드는 동시에 실행될 수 없다. 윈도우는 프로세서 시간 공유를 통해, 프로세서가 다음 스레드를 작업하기 전까지 정해진 시간 내에서 스레드가 실행되도록 한다. 이러한 스레드를 바꾸는 작업을 문맥 교환(context switching)이라 하며 dispatcher에서 담당한다. Dispatcher는 스레드를 어느 프로세서로 분배할지 결정하는 요인으로 (1) 우선권, (2) 이상적 프로세서 및 Affinity, (3) 퀀텀 (일명 time slice), 그리고 (4) 상태가 있다.

### 우선권
> Microsoft Document에서는 Dispatcher에 영향을 주는 요인이라 하지만, 본인은 Scheduler와 더 연관이 있다고 판단한다.

프로세스 우선권은 스케줄러가 어떤 스레드를 실행시킬 것인지 선택하는 핵심 요소이다. 우선권은 0~31 범위의 정수로 나타난다. 실행될 준비가 된 스레드가 현재 실행되고 있는 스레드보다 더 높은 우선권을 갖고 있으면 선점형(preemptive) 스케줄링에 의해 곧바로 고우선권 스레드로 문맥 교환된다.

스레드가 실행 중이거나 실행될 준비가 되었을 시, 높은 우선권과 같이 실행할 만큼의 프로세서 개수가 있지 않는 한 낮은 우선권의 스레드는 실행될 수 없다. 아니면 높은 우선권의 스레드가 특정 프로세서에서만 실행되어야 하는 "이상적 프로세서" 혹은 "프로세서 Affinity"에 의해 높은 우선권의 스레드가 실행될 수 있도록 제한되어야 한다. 스레드는 base 우선권으로부터 높은 우선권으로 부스트될 수 있는 경우가 존재한다.

### 이상적 프로세서 및 Affinity
스레드의 이상자거 프로세서 및 Affinity는 스레드가 어느 프로세서에서 실행될지 영향/결정하는 요인으로 작용한다. 각 스레드는 프로그램 혹은 운영체제로부터 자동으로 설정된 이상적 프로세서가 있다. 운영체제는 round-robin 방법론을 통해 각 프로세서에 각 프로세스의 대략적으로 동일한 개수의 스레드가 할당될 수 있도록 한다. 운영체제는 가능한 스레드를 이상적 프로세서에 전달하려 하지만, 강제되는 것이 아니다.

그와 반대로 Affinity는 스레드가 반드시 해당 프로세서에서만 실행되어야 하도록 지정한다.

### 퀀텀
일명 time slice이다. 퀀텀 지속시간은 시스템이 즉각적으로 반응할 수 있도록 설계되었다.

### 상태
Block 상태에 있는 스레드는 필연적으로 성능 문제를 가리키지 않는다. 대부분 스레드는 상당한 시간을 Block 상태에 놓여있어, 이는 프로세서가 idle 상태에 들어가 에너지를 절약하도록 한다. 오로지 사용자가 스레드가 작업을 마치는데 기다릴 때에만 스레드 상태는 성능에 있어 매우 중요한 요인으로 작용한다.

### DPC 및 ISR
스레드를 처리하는 것 외에도, 프로세서는 네트워크 카드나 타이머 등의 하드웨어 장치로부터의 알림에 대하여 반응한다. 이들 하드웨어가 장치가 프로세서의 관심을 받기 위한 방법으로 인터럽트를 생성한다. 운영체제는 하드웨어 인터럽트에 대응하기 위해 현재 실행되고 있는 스레드를 유예시키고 해당 인터럽트에 대응하는 ISR(Interrupt Service Routines; 인터럽트 서비스 루틴)을 실행한다.

ISR을 실행하는 동안, 프로세서는 타 인터럽트 등의 다른 활동을 처리하는 것으로부터 방지될 수 있다. 이러한 이유로 ISR은 빨리 끝내야되며, 그렇지 않으면 시스템 성능이 저하될 수 있다. 실행 시간을 줄이기 위해, ISR은 인터럽트에 대응한 작업을 수행하기 위해 흔히 DPC(Deferred Procedure Call)를 스케줄링한다. 운영체제는 각 논리 프로세서에 대기 중인 스케줄된 DPC를 관리한다. 프로세서가 스레드를 처리로 돌아기기 전에 대기 중인 DPC를 모두 실행한다.

프로세서가 DPC 및 ISR을 실행하는 시간 도중, 어떠한 스레드도 프로세서에서 실행될 수 없다. 이러한 성질은 일정 시간 내에 처리되어야 할 스레드 혹은 정확한 타이밍에 처리되어야 할 스레드에게 있어 문제가 될 수 있는다 (오디오 및 비디오 관련 스레드 등). 만일 DPC 및 ISR을 실행하기 위해 사용된 프로세서 시간이 이러한 스레드가 충분히 처리될 시간을 할당받는 것을 방지한다면, 스레드는 정해진 시간 안에 충분히 처리되지 못하거나 정확한 타이밍에 처리되지 못하게 될 것이다.

# 윈도우 ADK 도구
윈도우 ADK는 하드웨저 정보와 평가를 assessment results files에 write한다. WPA는 다양한 그래프에서 CPU 사용량 정보를 제공한다. 본 장에서는 윈도우 ADK 및 WPA(Windows Performance Analyzer)로 어떻게 CPU 성능 데이터를 수집, 관측, 그리고 분석하는데 사용하는지 설명한다.

## Windows Performance Recorder
> https://docs.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-recorder

* `First Level Triage` -> `First Level Triage`: ...what's this???
* `Resource Analysis` -> `CPU Usage`

> Xperf나 NT Kernel Logger를 사용하는 어플리케이션을 사용하는 중에 WPR을 실행할 때, WPR은 다른 어플리케이션에서 성능 기록을 진행하고 있는 것을 감지하지 못한다. 허나 기록을 진행할 때에 충돌이 있다는 것을 확인하여 알림을 준다.

만일 OK를 누르면 현재 진행 중인 세션을 끝내고 기록을 진행하는데, 이는 어플리케이션에 영향을 줄 수 있다. Cancel을 누르면 기록을 하지 않으며 어플리케이션에 영향을 주지 않는다.

마무리되었으면, WPR은 `.ETL` 파일을 생성한다. 바로 해당 파일이 WPA에서 분석하기 위해 사용된다.

## Windows Performance Analyzer
> https://docs.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-analyzer

WPR로 기록된 `.ETL`을 연다.

사용 가능한 그래프들은 모두 Graph Explorer 창에 나타나있다. 각 그래프 상단 좌측에 있는 역삼각형을 클릭하여 압축된 그래프 내용을 분류별로 나누어 보여준다. 확인하고자 하는 그래프를 Analysis 탭(메인 뷰)로 드래그 혹은 더블클릭하여 볼 수 있다. 그래프 창 caption 우측에서 그래프, 테이블, 아니면 둘 다 볼 것인지 시각 데이터 유형을 고를 수 있다.

그래프 위에 마우스를 좌우로 드래그하여 시간간격을 지정할 수 있다. 이렇게 지정된 시간간격은 동일한 Analysis 탭 하에 있는 모든 그래프도 동일하게 적용된다.

이렇게 지정된 시간간격에 대하여 오른쪽 클릭을 하면 zoom-in 기능이 있다. 반복적으로 하여 매우 작은 순간에 대한 데이터도 찾아볼 수 있다. Zoom-in을 하면 동일한 Analysis 탭 안에 있는 그래프가 함께 영향을 받기 때문에, 만일 그렇게 되는걸 원치 않으면 새로운 탭에서 띄우는 것을 권장한다.

시간간격을 하이라이트할 수 있으나, Analysis 탭 한 개당 하나만 제공된다. 이 또한 오른쪽 클릭으로 하이라이트가 가능하다.

데이터 테이블에서 테이블 열을 어느 위치로든 옮길 수 있다. 테이블 헤더로 정렬도 할 수 있다. 데이터 테이블을 바꾸면 그래프 왼쪽에 "Series"라는 그래프 범류에도 영향을 미친다. 테이블 범류와 그래프 범류는 서로 일치한다.

데이터 테이블 중에서 보이거나 숨길 테이블 열을 선택하여 커스터마이징이 가능하다. 테이블은 pivot table이다; 테이블의 금색과 푸른색 수직선 사이에 위치한 열들이 data 열이다. 만일 금색 수직선이 보이지 않으면 왼쪽으로 스크롤하도록 한다. 금색 수직선의 왼쪽으로 옮긴 테이블 열은 key가 된다. 그래프에 표시될 데이터는 푸른색 수직선 오른쪽으로 옮긴다.

원하는 레이아웃을 지정하고 싶으면 View Profile을 생성하여 매번 WPA를 열거나 혹은 특정 종류의 파일을 열었을 때에만 레이아웃 자동정렬이 되도록 할 수 있다. Profile 메뉴에서 Export로 새로운 View Profile을 생성하고 Apply를 눌러 곧바로 레이아웃을 적용시키거나 Save Startup Profile으로 WPA를 매번 열때 적용되도록 할 수 있다.

Diagnostic Console은 analysis workflow에서 발생한 exception들을 나열한다. 심볼 디코딩 이슈를 이곳으로부터 진단할 수 있다.

Windows Assessment Console에서 진행된 assessment를 WPA에 열어 추가적인 분석을 제공하면, assessment에서 식별한 이슈들은 Issue 창에 나타난다. 해당 창에 들어있는 issue를 클릭하면 상세한 내용과 권장된 해결방법이 Analysis 탭 하에 Issue Details에 나타난다. 

## 윈도우 ADK Assessment Results Files
윈도우는 오로지 symmetric multiprocessing 시스템만을 지원하기 때문에, 본문에 있는 모든 정보는 설치된 모든 CPU 및 코어에 일관된다. 

